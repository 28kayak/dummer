#!/usr/bin/env ruby
require 'thor'

module DummyLogGeneratorSimple
  class CLI < Thor
    default_command :start
    desc "start", "Start a dummy_log_generator"
    option :sync,        :aliases => ["-s"], :type => :boolean
    option :duration,    :aliases => ["-d"], :type => :numeric, :default => 1
    option :concurrency, :aliases => ["-c"], :type => :numeric, :default => 1
    option :filename,    :aliases => ["-f"], :type => :string, :default => 'dummy.log'
    option :message,     :aliases => ["-m"], :type => :string,
      :default => "time:2013-11-20 23:39:42 +0900\tlevel:ERROR\tmethod:POST\turi:/api/v1/people\treqtime:3.1983877060667103\n"
    def start
      sync        = @options[:sync]
      concurrency = @options[:concurrency]
      filename    = @options[:filename]
      message     = @options[:message]
      duration    = Time.now + @options[:duration]
      pids = []
      open(filename, (File::WRONLY | File::APPEND | File::CREAT)) do |output|
        output.sync = true if sync
        concurrency.times do |i|
          pids[i] = Process.fork do
            while true do
              output.write message
            end
          end
        end
        while Time.now < duration do; sleep 0.01; end
        concurrency.times do |i|
          Process.kill(:TERM, pids[i])
        end
      end
    end
  end
end

DummyLogGeneratorSimple::CLI.start(ARGV)
