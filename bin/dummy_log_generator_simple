#!/usr/bin/env ruby
require 'thor'
require 'parallel'

module DummyLogGeneratorSimple
  class CLI < Thor
    default_command :start
    desc "start", "Start a dummy_log_generator"
    option :duration,    :aliases => ["-d"], :type => :numeric, :default => 1
    option :concurrency, :aliases => ["-c"], :type => :numeric, :default => 1
    option :filename,    :aliases => ["-f"], :type => :string, :default => 'dummy.log'
    option :message,     :aliases => ["-m"], :type => :string,
      :default => "time:2013-11-20 23:39:42 +0900\tlevel:ERROR\tmethod:POST\turi:/api/v1/people\treqtime:3.1983877060667103\n"
    def start
      concurrency = @options[:concurrency]
      filename    = @options[:filename]
      message     = @options[:message]
      duration    = Time.now + @options[:duration]
      open(filename, (File::WRONLY | File::APPEND | File::CREAT)) do |output|
        output.sync = true
        Parallel.map(['a']*concurrency, :in_processes => concurrency) do |letter|
          while Time.now < duration do
            output.write message
          end
        end
      end
    end
  end
end

DummyLogGeneratorSimple::CLI.start(ARGV)

